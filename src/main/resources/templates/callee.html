<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Callee</title>
  <link rel="icon" href="data:;base64,=">
</head>
<body data-call="{{call}}">
<button type="button" id="start-button">start</button>
<div>
  <video id="localVideo" autoplay playsinline controls="false"></video>
  <video id="removeVideo" autoplay playsinline controls="false"></video>
</div>
<input type="text" id="input-box">
<button type="button" id="send-button">Send</button>
<ul id="chat-box">

</ul>
<script type="text/javascript" src="/webjars/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript" src="/webjars/sockjs-client/1.1.2/sockjs.min.js"></script>
<script type="text/javascript">
  $(function () {
    const configuration = {
      'iceServers': [
        {
          'urls': [
            'stun:stun.l.google.com:19302',
            'stun:stun1.l.google.com:19302',
            'stun:stun2.l.google.com:19302',
            'stun:stun3.l.google.com:19302',
            'stun:stun4.l.google.com:19302'
          ]
        }
      ]
    };
    const peerConnection = new RTCPeerConnection(this.configuration);
    const sockJs = new SockJS("/ws/webrtc");
    sockJs.onopen = function () {
      console.log('signaling connected');
      sockJs.onmessage = async event => {
        const message = JSON.parse(event.data);
        console.log('signaling message: ', message);
        // WebRTC 연결 요청 받은 경우
        if (message.offer) {
          await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          sockJs.send(JSON.stringify({'answer': answer}));
        }
        // ICE Candidate 요청을 받은 경우
        if (message.candidate) {
          peerConnection.addIceCandidate(message.candidate)
                        .then(() => console.log('icecandidate added'))
                        .catch(e => {
                          console.error('Error adding received ice candidate', e);
                        });
        }
      };
    };

    peerConnection.onicecandidate = event => {
      if (event.candidate) {
        sockJs.send(JSON.stringify({'candidate': event.candidate}));
      }
    };

    const remoteStream = new MediaStream();
    peerConnection.ontrack = event => {
      console.log('ontrack', event);
      document.querySelector('#remoteVideo').srcObject = remoteStream;
      peerConnection.addTrack(event.track, remoteStream);
    };
  });
</script>
</body>
</html>